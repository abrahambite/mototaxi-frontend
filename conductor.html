<script>
  const choferId = localStorage.getItem("user_id");

  async function cargarViajes() {
    try {
      const res = await fetch("https://mototaxi-api-production.up.railway.app/viajes");
      const viajes = await res.json();
      const contenedor = document.getElementById("lista-viajes");
      contenedor.innerHTML = "";

      const pendientes = viajes.filter(v => v.estado === "pendiente" && !v.conductor_id);

      if (!pendientes.length) {
        contenedor.innerHTML = "<p>No hay viajes disponibles.</p>";
        return;
      }

      pendientes.forEach(viaje => {
        const div = document.createElement("div");
        div.className = "viaje";
        div.innerHTML = `
          <strong>Origen:</strong> ${viaje.origen.lat}, ${viaje.origen.lng}<br>
          <strong>Destino:</strong> ${viaje.destino.lat}, ${viaje.destino.lng}<br><br>
          <button onclick="aceptarViaje(${viaje.id})">üöï Aceptar Viaje</button>
        `;
        contenedor.appendChild(div);
      });
    } catch (err) {
      alert("Error al cargar los viajes.");
      console.error(err);
    }
  }

  async function aceptarViaje(id) {
    try {
      const res = await fetch(`https://mototaxi-api-production.up.railway.app/viajes/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ estado: "aceptado", conductor_id: choferId })
      });

      const data = await res.json();
      if (!res.ok) {
        alert("‚ùå " + data.error);
        return;
      }

      window.location.href = `seguimiento_chofer.html?viaje=${id}`;
    } catch (err) {
      alert("No se pudo aceptar el viaje.");
      console.error(err);
    }
  }

  cargarViajes();
</script>
