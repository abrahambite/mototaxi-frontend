<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento - MotoTaxi</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <img src="img/logo.jpeg" alt="Logo MotoTaxi" style="max-width: 150px; margin: 10px auto; display: block;" />
    <h2>Tu unidad viene en camino ğŸ›µ</h2>
    <div id="map" style="width: 100%; height: 400px; margin-bottom: 15px;"></div>
    <div id="choferInfo" style="margin-bottom: 10px;">
      ğŸ‘¤ <strong>Chofer:</strong> Cargando...<br>
      ğŸï¸ <strong>Unidad:</strong> Cargando...<br>
      ğŸ“ <strong>Contacto:</strong> Cargando...
    </div>
    <button id="cancelarViaje" style="background-color: crimson; color: white; padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
      Cancelar Viaje
    </button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const viajeId = urlParams.get("viaje");
    let viaje, map, userMarker, driverMarker;

    async function cargarViaje() {
      try {
        const res = await fetch("https://mototaxi-api-production.up.railway.app/viajes");
        const viajes = await res.json();
        viaje = viajes.find(v => v.id == viajeId);

        if (!viaje) throw new Error("No se encontrÃ³ el viaje.");

        if (!viaje.origen || !viaje.destino) throw new Error("Faltan datos de ubicaciÃ³n.");

        await cargarChofer(viaje.conductor_id);
        initMap(viaje.origen, viaje.destino);
      } catch (err) {
        alert(err.message);
        console.error("Error al cargar el seguimiento:", err);
      }
    }

    async function cargarChofer(id) {
      try {
        const res = await fetch("https://mototaxi-api-production.up.railway.app/usuarios");
        const usuarios = await res.json();
        const chofer = usuarios.find(u => u.id === id);

        if (chofer) {
          document.getElementById("choferInfo").innerHTML = `
            ğŸ‘¤ <strong>Chofer:</strong> ${chofer.nombre}<br>
            ğŸï¸ <strong>Unidad:</strong> ${chofer.vehiculo || "-"}<br>
            ğŸ“ <strong>Contacto:</strong> ${chofer.telefono || "-"}
          `;
        }
      } catch (error) {
        console.error("Error al cargar el chofer:", error);
      }
    }

    function initMap(origen, destino) {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: origen
      });

      userMarker = new google.maps.Marker({ position: origen, map: map, label: "A" });
      driverMarker = new google.maps.Marker({ position: destino, map: map, label: "B" });
    }

    document.getElementById("cancelarViaje").addEventListener("click", function () {
      alert("El viaje ha sido cancelado.");
      window.location.href = "solicitud-viaje.html";
    });

    cargarViaje();
  </script>

  <!-- Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdREUrEpKTCtslj4zw-2BDE_LO4wVABnI"></script>
</body>
</html>
