<!-- Archivo: conductor.html -->
<!-- Ya redirige correctamente a seguimiento_chofer.html -->

<script>
  const API_URL = "https://mototaxi-api-production.up.railway.app";
  let conductor_id = localStorage.getItem("conductor_id");
  if (!conductor_id) {
    conductor_id = prompt("Ingresa tu ID de conductor:");
    localStorage.setItem("conductor_id", conductor_id);
    localStorage.setItem("tipo_usuario", "conductor");
  }

  function cargarViajes() {
    fetch(`${API_URL}/viajes`)
      .then(res => res.json())
      .then(data => {
        const contenedor = document.getElementById("viajes");
        contenedor.innerHTML = "";

        const pendientes = data.filter(v => v.estado === "pendiente");

        if (pendientes.length === 0) {
          contenedor.innerHTML = "<p>No hay viajes disponibles por ahora.</p>";
          return;
        }

        pendientes.forEach(viaje => {
          const card = document.createElement("div");
          card.className = "viaje-card";

          card.innerHTML = `
            <h3>Viaje #${viaje.id}</h3>
            <p><strong>Origen:</strong> ${JSON.stringify(viaje.origen)}</p>
            <p><strong>Destino:</strong> ${JSON.stringify(viaje.destino)}</p>
            <p class="estado">Estado: ${viaje.estado}</p>
            <button onclick="aceptarViaje(${viaje.id}, this)">Aceptar Viaje</button>
          `;

          contenedor.appendChild(card);
        });
      });
  }

  function aceptarViaje(viajeId, boton) {
    boton.disabled = true;
    boton.textContent = "Asignando...";

    fetch(`${API_URL}/viajes/${viajeId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        conductor_id: conductor_id,
        estado: "aceptado"
      })
    })
      .then(res => res.json())
      .then(data => {
        alert("âœ” Viaje aceptado");
        window.location.href = `seguimiento_chofer.html?viaje=${viajeId}`;
      })
      .catch(err => {
        alert("Error al aceptar viaje");
        boton.disabled = false;
        boton.textContent = "Aceptar Viaje";
      });
  }

  cargarViajes();
  setInterval(cargarViajes, 10000);
</script>
