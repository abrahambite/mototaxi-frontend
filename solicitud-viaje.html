<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitar Viaje - MotoTaxi</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>Solicitar un Viaje</h2>
    <form id="solicitudViaje">
      <label for="destino">Destino:</label>
      <input type="text" id="destino" name="destino" placeholder="Ingresa tu destino" required />

      <label>Método de Pago:</label>
      <div class="radio-container">
        <label><input type="radio" name="pago" value="efectivo" checked /> Efectivo</label>
        <label><input type="radio" name="pago" value="tarjeta" /> Tarjeta</label>
      </div>

      <button type="submit">Solicitar Viaje</button>
    </form>

    <h3>Ruta</h3>
    <div id="map" style="width: 100%; height: 300px;"></div>
    <p id="estadoRuta">Esperando coordenadas...</p>
  </div>

  <script>
    let origenCoords = null;
    let destinoCoords = null;

    const pasajeroId = localStorage.getItem("user_id");
    if (!pasajeroId) {
      alert("Debes iniciar sesión como cliente para solicitar un viaje.");
      window.location.href = "login.html";
    }

    document.getElementById("solicitudViaje").addEventListener("submit", async function (event) {
      event.preventDefault();
      const metodoPago = document.querySelector("input[name='pago']:checked").value;
      const destinoInput = document.getElementById("destino").value;

      if (!origenCoords || !destinoCoords) {
        alert("Las coordenadas de origen o destino no están listas.");
        return;
      }

      const viaje = {
        pasajero_id: parseInt(pasajeroId),
        origen: origenCoords,
        destino: destinoCoords,
        metodo_pago: metodoPago
      };

      try {
        const res = await fetch("https://mototaxi-api-production.up.railway.app/viajes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(viaje)
        });

        const data = await res.json();
        if (!res.ok) {
          alert("Error al solicitar el viaje: " + data.error);
          return;
        }

        alert("🚕 Viaje solicitado con éxito.");
        window.location.href = "seguimiento.html?viaje=" + data.viaje.id;
      } catch (err) {
        console.error("Error al guardar el viaje:", err);
        alert("Error al guardar el viaje.");
      }
    });

    function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 32.6245, lng: -115.4521 },
        zoom: 14
      });

      const destinoInput = document.getElementById("destino");
      const autocomplete = new google.maps.places.Autocomplete(destinoInput);

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          alert("Por favor selecciona una dirección válida del autocompletado.");
          return;
        }
        destinoCoords = {
          lat: place.geometry.location.lat(),
          lng: place.geometry.location.lng()
        };
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          origenCoords = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          new google.maps.Marker({ position: origenCoords, map, label: "Tú" });
          map.setCenter(origenCoords);
          document.getElementById("estadoRuta").innerText = `Tu ubicación actual: ${origenCoords.lat}, ${origenCoords.lng}`;
        }, () => {
          alert("No se pudo obtener tu ubicación actual.");
        });
      }
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&libraries=places&callback=initMap"></script>
</body>
</html>
