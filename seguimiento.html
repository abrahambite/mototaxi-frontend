<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seguimiento - MotoTaxi</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <img src="img/logo.jpeg" alt="Logo MotoTaxi" style="max-width: 150px; margin: 10px auto; display: block;" />
    <h2>Tu unidad viene en camino 🛵</h2>

    <div id="map" style="width: 100%; height: 400px; margin-bottom: 15px;"></div>

    <div id="choferInfo" style="margin-bottom: 10px; font-size: 16px;">
      Cargando información del viaje...
    </div>

    <button id="cancelarViaje" style="background-color: crimson; color: white; padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer;">
      Cancelar Viaje
    </button>
  </div>

  <script>
    const viajeId = new URLSearchParams(window.location.search).get("viaje");
    const choferInfo = document.getElementById("choferInfo");
    let map, markerCliente, markerChofer, ruta;

    if (!viajeId) {
      choferInfo.innerText = "Error: No se proporcionó ID de viaje.";
    } else {
      fetch(`https://yago.digital/api/viajes/${viajeId}`)
        .then(res => res.json())
        .then(viaje => {
          choferInfo.innerHTML = `
            👤 <strong>Chofer:</strong> ${viaje.chofer?.nombre || "No asignado"}<br>
            🏍️ <strong>Unidad:</strong> ${viaje.chofer?.vehiculo || "N/A"}<br>
            📞 <strong>Contacto:</strong> ${viaje.chofer?.telefono || "N/A"}
          `;

          initMap(viaje);
        })
        .catch(err => {
          choferInfo.innerText = "No se pudo cargar el viaje.";
          console.error(err);
        });
    }

    function initMap(viaje) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: viaje.destino,
        zoom: 14,
      });

      markerCliente = new google.maps.Marker({
        position: viaje.destino,
        map,
        label: "Destino",
        icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
      });

      markerChofer = new google.maps.Marker({
        map,
        label: "Moto",
        icon: "http://maps.google.com/mapfiles/ms/icons/motorcycling.png"
      });

      actualizarUbicacionChofer(viaje.chofer?.id);
      setInterval(() => actualizarUbicacionChofer(viaje.chofer?.id), 8000);
    }

    function actualizarUbicacionChofer(choferId) {
      if (!choferId) return;

      fetch(`https://yago.digital/api/ubicacion/${choferId}`)
        .then(res => res.json())
        .then(data => {
          if (!data || !data.lat || !data.lng) return;
          const posicion = { lat: data.lat, lng: data.lng };
          markerChofer.setPosition(posicion);
          map.panTo(posicion);
        })
        .catch(console.error);
    }

    document.getElementById("cancelarViaje").onclick = () => {
      alert("Viaje cancelado. Regresando...");
      window.location.href = "solicitud-viaje.html";
    };
  </script>

  <!-- API de Google Maps -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdREUrEpKTCtslj4zw-2BDE_LO4wVABnI">
  </script>
</body>
</html>
